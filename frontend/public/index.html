<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login Form with Vue.js</title>
    <!-- Include Bootstrap CSS -->
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div id="app" class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    Login
                </div>
                <div class="card-body">

                    <!-- Sign Up Form -->
                    <form v-if="isSignUp" @submit.prevent="submitForm('users', 'Sign Up')">
                        <div class="form-group">
                            <label for="username">Email</label>
                            <input type="text" class="form-control" v-model="email" required>
                        </div>
                        <div class="form-group">
                            <label for="password">Password</label>
                            <input type="password" class="form-control" v-model="password" required>
                        </div>
                        <button type="submit" class="btn btn-primary" v-if="!sessionToken" >Sign Up</button>
                    </form>

                    <!-- Sign In Form -->
                    <form v-else @submit.prevent="submitForm('login', 'Sign In')">
                        <div class="form-group">
                            <label for="username">Email</label>
                            <input type="text" class="form-control" v-model="email" required>
                        </div>
                        <div class="form-group">
                            <label for="password">Password</label>
                            <input type="password" class="form-control" v-model="password" required>
                        </div>
                        <button type="submit" class="btn btn-primary" v-if="!sessionToken" >Sign In</button>
                    </form>

                    <!-- Toggle Sign Up / Sign In Form -->
                    <button class="btn btn-secondary mt-3" @click="toggleForm">{{ isSignUp ? 'Switch to Sign In' : 'Switch to Sign Up' }}</button>

                </div>
            </div>
        </div>
    </div>
</div>

<!-- Include Vue.js and Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>


    new Vue({
        el: '#app',
        data: {
            email: '',
            password: '',
            isSignUp: true,
            sessionToken: localStorage.getItem('sessionToken') || '', // Default to token from storage if available.
        },
        created() { // Vue lifecycle hook
            // Set axios default headers on instance creation if token is present
            if (this.sessionToken) {
                axios.defaults.headers.common['Authorization'] = `Bearer ${this.sessionToken}`;
            }
        },
        methods: {
            async submitForm(endpoint, action) {
                try {
                    const headers = {
                        'Content-Type': 'application/json',
                        'Authorization': this.sessionToken ? `Bearer ${this.sessionToken}` : undefined
                    };

                    const response = await axios.post(`/${endpoint}`, {
                        email: this.email,
                        password: this.password,
                    }, {
                        headers: headers
                    });
                    console.log(response);

                    if (this.password.length < 8) {
                        alert('Password must be at least 8 characters long');
                    } else {
                        if (response.data && response.data.sessionToken) {
                            this.sessionToken = response.data.sessionToken;
                            localStorage.setItem('sessionToken', this.sessionToken);
                            axios.defaults.headers.common['Authorization'] = `Bearer ${this.sessionToken}`;

                            if (endpoint === 'login') {
                                const token = localStorage.getItem('sessionToken');
                                if (token && window.location.pathname === '/') {
                                    window.location.href = '/dashboard';
                                } else if (!token) {
                                    window.location.href = '/';
                                }
                            }

                        } else if (response.data.error) {
                            if (response.data.error.includes('already exists')) {
                                alert('User already exists. Please use a different email.');
                            } else {
                                alert(`${action} failed: ${response.data.error}`);
                            }
                        }
                    }

                } catch (error) {
                    if (error.response) {
                        switch (error.response.status) {
                            case 409:
                                alert('User already exists. Please use a different email.');
                                break;
                            case 401:
                                alert('Invalid credentials');
                                break;
                            default:
                                alert('An error occurred.');
                                break;
                        }
                    } else {
                        alert('An error occurred.');
                        console.error(error);
                    }
                }
            },
            toggleForm() {
                this.isSignUp = !this.isSignUp;
            },
            clearStorageAndToggleLoginButtons() {
                this.sessionToken = '';
                localStorage.removeItem('sessionToken');
                delete axios.defaults.headers.common['Authorization']; // Clear axios default header
            },
            // ... (other methods, if any)
        },
    });

</script>
</body>
</html>
